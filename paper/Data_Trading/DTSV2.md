# Data Trading System Version2

### Roles

- Buyer：拥有自己的数据分析算法，需要数据进行分析。
- Seller：向Buyer提供数据分析服务。
- 数据计算服务系统：结合Seller提供的原始数据和Buyer的算法，进行数据分析服务。
- 结算系统: 负责Buyer和Seller的数据服务交易结算。

### System Properties

- 正确运行Buyer的算法，确保Buyer的算法不被篡改。
- Buyer的数据分析结果不被泄露、篡改。
- buyer对请求的服务支付必要的报酬。
- Seller可以得到应有的报酬。
- Seller拥有数据的绝对控制权。
- Seller的数据在数据计算服务过程中不会被泄露和篡改。
- 具有高性能、支持复杂的分析算法。
- Buyer的数据运行算法不会被泄露。

###  威胁模型

- Buyer的算法被篡改，数据计算服务系统未能执行buyer真正的分析算法。
  - Buyer的算法在传输至数据计算服务系统的过程中或者在执行的过程中被强行修改。
  - **应对策略：**本文利用SGX中的 enclave与Buyer建立side channel，通过该通道，将Buyer的执行程序以加密的方式传输至数据计算服务系统中，保证执行程序在传输过程中不会被篡改。
  - 加密的执行程序在enclave被解密，随后执行，enclave的安全可行执行环境保证分析程序执行过程不会被外界修改。
- Buyer的分析执行结果被外界修改。
  - **应对策略：**SGX中的enclave保证Buyer的程序在执行过程中不会被修改，当执行完毕后，enclave会使用内部生成的公钥对执行结果加密，并使用公钥对结果进行签名，随后将结果发送至数据服务智能合约中，由于enclave生成的公私钥只传输给Buyer，因此最终加密的执行结果只能被Buyer解密，如果Buyer无法成功解密，则表明执行结果已经被篡改。
- Buyer得到执行结果后拒绝支付。
  - **应对策略：**使用区块链中智能合约，在Buyer购买数据分析服务之前，需要在计算服务智能合约中预支付数据服务费用，enclave执行完毕数据分析程序后，使用公钥对执行结果的哈希值进行签名，将加密后的执行结果、签名和公钥上传至智能合约中，数据服务智能合约验证签名，如果签名验证通过，表明enclave已经正确执行了分析程序并且返回了执行结果，此时会自动将数据服务费用转移至Seller的账户。

- Buyer的数据分析算法窃取Seller的数据
  - 当数据计算服务系统启动buyer的分析算法并且读入seller的数据时，分析算法输出Seller的原始数据以作为执行结果。由于执行结果只能被Buyer获取，外界难以感知到数据窃取行为。
  - **应对策略：**本文提出的数据交易系统中使用静态代码分析技术，跟踪buyer的分析程序对原始数据的操作，一旦出现对原始数据的相关输出，会立刻停止执行程序以终止窃取行为。
- Seller提供修改数据
  - **应对策略：**Seller在出售数据计算服务时，会对数据进行分块，并对每一块对应的内容求取哈希值，然后将各哈希值上链。Buyer和数据计算服务中的enclave建立连接时，将数据块个数和各数据块的哈希值传输给enclave，enclave在读取Seller的数据后会求取哈希值并和Buyer提供的哈希值进行校验，如果不符合，则表明Seller提供了虚假的数据。
- 合谋攻击
  - **应对策略：**由于在本系统中，Buyer和Seller都可以单独验证，Seller和数据计算服务系统的合谋对执行程序或者执行结果的篡改可以被buyer检测到，Buyer即使和数据计算服务系统合谋也无法窃取Seller的数据，更不能赖账，因此本文的系统设计可以抵御上述攻击。

